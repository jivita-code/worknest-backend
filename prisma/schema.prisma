// Prisma schema file

generator client {
  provider = "prisma-client-js"
  output   = "generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Subscription {
  sub_id         String    @id @default(uuid()) @db.Uuid
  org_id         String?   @unique @db.Uuid
  plan_id        String?   @db.Uuid
  start_date     DateTime
  end_date       DateTime
  renewal_date   DateTime?
  billing_cycle  String    // 'monthly' | 'annual'
  status         String    // 'active' | 'expired' | 'canceled' | 'trial'
  auto_renew     Boolean   @default(false)
  trial_end_date DateTime?
  cancelled_at   DateTime?
  payment_method String?   // 'payhere' | 'stripe'
  created_at     DateTime  @default(now())
  update_at      DateTime  @updatedAt

  // Relations
  organization   Organization? @relation(fields: [org_id], references: [org_id])
  plan           Plan?         @relation(fields: [plan_id], references: [plan_id])
  invoices Invoice[]

  @@map("subscriptions")
}

model Department {
  dep_id                String    @id @default(uuid()) @db.Uuid
  org_id                String    @db.Uuid
  name                  String
  head_id               String?   @unique @db.Uuid
  parent_department_id  String?   @db.Uuid 
  created_at            DateTime  @default(now())
  update_at             DateTime  @updatedAt

  // Relations
  organization          Organization @relation(fields: [org_id], references: [org_id])
  parent_department     Department?  @relation("DepartmentHierarchy", fields: [parent_department_id], references: [dep_id])
  sub_departments       Department[] @relation("DepartmentHierarchy")
  head                  Employee?    @relation("DepartmentHead", fields: [head_id], references: [emp_id])
  employees             Employee[]

  @@map("departments")
}

model Employee {
  emp_id             String    @id @default(uuid()) @db.Uuid
  org_id             String    @db.Uuid
  dep_id             String?   @db.Uuid
  employee_number    String
  first_name         String
  last_name          String
  email              String    @unique
  password           String
  phone              String?
  profile_photo_url  String?
  designation        String?
  employment_type    String    // 'full-time', 'part-time', 'intern', 'contract'
  join_date          DateTime?
  resign_date        DateTime?
  status             String    // 'active' | 'resigned'
  created_at         DateTime  @default(now())
  update_at          DateTime  @updatedAt

  // Relations
  organization       Organization @relation(fields: [org_id], references: [org_id])
  department         Department?  @relation(fields: [dep_id], references: [dep_id])
  headed_department  Department?  @relation("DepartmentHead")
  attendances        Attendance[]
  leave_requests     LeaveRequest[]
  approved_leaves    LeaveRequest[] @relation("LeaveApprover")
  petty_cash_requests PettyCashRequest[]
  approved_petty_cash PettyCashRequest[] @relation("PettyCashApprover")

  @@map("employees")
}

model Organization {
  org_id         String    @id @default(uuid()) @db.Uuid
  sub_id         String?    @db.Uuid
  name           String
  industry       String?
  registration_no String?
  address        String?
  email          String
  password	     String
  phone          String?
  logo_url       String?
  created_at     DateTime  @default(now())
  update_at      DateTime  @updatedAt
  
  // Relations
  subscription   Subscription?
  invoices       Invoice[]
  departments    Department[]
  employees      Employee[]
  attendances    Attendance[]
  leave_requests LeaveRequest[]
  petty_cash_requests PettyCashRequest[]
  @@map("organizations")
}

model Plan {
  plan_id        String    @id @default(uuid()) @db.Uuid
  name           String    @unique 
  description    String?
  price_monthly  Float?
  price_annual   Float?
  currency       String    // 'LKR' | 'USD'
  max_employees  Int?
  is_active      Boolean   @default(true)
  created_at     DateTime  @default(now())
  update_at      DateTime  @updatedAt
  
  // Relations
  subscriptions  Subscription[]
  features       Feature[] @relation("plan_features")

  @@map("plans")
}

model Feature {
  fet_id      String   @id @default(uuid()) @db.Uuid
  name        String @unique
  created_at  DateTime @default(now())
  update_at   DateTime @updatedAt
  
  // Relations
  plans       Plan[]   @relation("plan_features")

  @@map("features")
}

model Invoice {
  invoice_id     String    @id @default(uuid()) @db.Uuid
  org_id         String    @db.Uuid
  sub_id         String    @db.Uuid
  amount         Float
  currency       String    // 'LKR' | 'USD'
  renewal_date   DateTime?
  issue_date     DateTime
  due_date       DateTime
  paid_date      DateTime?
  receipt        String?
  status         String    // 'pending' | 'paid' | 'failed'
  cancelled_at   DateTime?
  payment_method String?   // 'payhere' | 'stripe'
  created_at     DateTime  @default(now())
  update_at      DateTime  @updatedAt

  // Relations
  organization   Organization @relation(fields: [org_id], references: [org_id])
  subscription   Subscription @relation(fields: [sub_id], references: [sub_id])

  @@map("invoices")
}

model Attendance {
  att_id            String    @id @default(uuid()) @db.Uuid
  org_id            String    @db.Uuid
  emp_id            String    @db.Uuid
  date              DateTime
  check_in_time     DateTime?
  check_in_location String?
  check_out_time    DateTime?
  check_out_location String?
  work_hours        Float?
  status            String    // 'present' | 'absent' | 'on_leave'
  created_at        DateTime  @default(now())
  update_at         DateTime  @updatedAt

  // Relations
  organization      Organization @relation(fields: [org_id], references: [org_id])
  employee          Employee     @relation(fields: [emp_id], references: [emp_id])

  @@map("attendances")
}

model LeaveRequest {
  leave_id      String    @id @default(uuid()) @db.Uuid
  org_id        String    @db.Uuid
  emp_id        String    @db.Uuid
  leave_type    String    // 'annual', 'casual', 'medical', 'maternity'
  start_date    DateTime
  end_date      DateTime
  reason        String?
  attachments   String?
  approved_by   String?   @db.Uuid // FK to Employee (approver)
  approved_date DateTime?
  status        String    // 'pending' | 'approved' | 'rejected'
  created_at    DateTime  @default(now())
  update_at     DateTime  @updatedAt

  // Relations
  organization  Organization @relation(fields: [org_id], references: [org_id])
  employee      Employee     @relation(fields: [emp_id], references: [emp_id])
  approver      Employee?    @relation("LeaveApprover", fields: [approved_by], references: [emp_id])

  @@map("leave_requests")
}

model PettyCashRequest {
  pet_id        String    @id @default(uuid()) @db.Uuid
  org_id        String    @db.Uuid
  emp_id        String    @db.Uuid
  amount        Float
  currency      String    // 'LKR' | 'USD'
  reason        String?
  request_date  DateTime
  request_type  String    // 'advance', 'meals', 'accommodation', 'other'
  attachments   String?
  approved_date DateTime?
  approved_by   String?   @db.Uuid // FK to Employee (approver)
  status        String    // 'pending' | 'approved' | 'rejected'
  created_at    DateTime  @default(now())
  update_at     DateTime  @updatedAt

  // Relations
  organization  Organization @relation(fields: [org_id], references: [org_id])
  employee      Employee     @relation(fields: [emp_id], references: [emp_id])
  approver      Employee?    @relation("PettyCashApprover", fields: [approved_by], references: [emp_id])

  @@map("petty_cash_requests")
}